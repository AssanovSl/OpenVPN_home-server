**OpenVPN** — один из самых популярных протоколов для организации VPN-соединения. С его помощью можно создать виртуальную частную сеть или объединять локальные сети. OpenVPN имеет открытый исходный код и бесплатно распространяется под лицензией GNU GPL. 

В интернет-центре Keenetic есть возможность настройки серверной части, эта возможность открывается после установки компонента системы "Клиент и сервер OpenVPN".  
Для работы достаточно веб-интерфейса (доступного по умолчанию по адресу 192.168.1.1)  


- Установка компонента **"Клиент и сервер OpenVPN"**.  
Параметры системы - изменить набор компонентов - Клиент и серевер OpenVPN  
![keenetic](./img/kenetic_install-openvpn.png)  
Роутер перезагрузится и компонеет будет установлен.  
После установки будет в меню **другие подключения** отобразится VPN, добавить подключение.
![keenetic](./img/keenetic-setup-openvpn.png)  
В выпадающем меню выбираю тип (протокол) **openVPN**  
![keenetic](./img/keenetic_add-connetc.png)  
После чего форма выдает текстовое поле в который и необходимо внести конфигурацию.  
Мое оборудование может выступать как в качестве клиента так и сервера, поведение определяется в конфигурации.  
В актуальных версиях keenetic, сервер работает только при указании в поле "Подключаться через" значения "Любое интернет-подключение" (меню дополительных настроек).

- Начальная конфигурация сервера.  
```
# Режим работы: сервер
mode server

# TCP/UDP и порт
proto udp        # Протокол (udp быстрее, tcp надежнее)
port 1194        # Порт по умолчанию

# Интерфейс и сетевые настройки
dev tun          # Виртуальный TUN-интерфейс (роутинг)
server 10.8.0.0 255.255.255.0  # Подсеть для клиентов

# Ключи и сертификаты
<secret>
-----BEGIN OpenVPN Static key V1-----
...
-----END OpenVPN Static key V1-----
</secret>

# Безопасность
cipher AES-256-CBC  #Алгоритм шифрования
auth SHA256         # Алгоритм аутентификации

# Клиентские настройки
client-to-client  #клиенты видят друг-друга
keepalive 10 120  #используется для стабильности подключения.

# Логирование
verb 3
```  
## Part 1. сервер OpenVPN ## 
Когда файл готов и добавленно подключение, остается несколько не сложных шагов.  
Используя веб интерфейс командной строки (CLI) роутера необходимо будет выполнить следующие команды:  
- Отключить глобальный IP:  
`interface OpenVPN0 no ip global`  
- Установить уромень безопаности:  
`interface OpenVPN0 security-level private`  
-Для разрешения обмена трафика OpenVPN0 с другими интерфейсами: 
`no isolate-private`  
- Для воможности выхода в интернет (трафик клиента полностью идет через VPN), нужно настроить NAT:  
`ip nat 10.1.0.2 255.255.255.255`  
- Сохранить внесенные изменения командой:  
`system configuration save`  

И откроем порт (указанный в конфиге) для этого возмользовавшись пунктом меню **межсетевой экран**  добавить правило "Разрешить", в  поле "Протокол" значение "UDP" и в поле "Номер порта назначения" значение "Равен" порт из конфигурации.  


На первом этапе рассмотрим режим работы OpenVPN со **статическим ключом** (static key).

- В этом режиме **нет сертификатов и PKI**, используется один общий ключ для шифрования и аутентификации.  
- Все клиенты и сервер используют один и тот же файл `secret.key`.  
- Настройка простая, но:
  - При компрометации ключа атакующий может расшифровать трафик.  
  - Нельзя гибко управлять доступом (например, отозвать ключ только у одного клиента).  
  - Нет масштабируемости: чем больше клиентов, тем сложнее управлять ключами.  

Этот режим может подойти только для **тестов или временного доступа**, но в боевых конфигурациях рекомендуется использовать PKI и TLS.

### Генерация статического ключа ###  
Для режима со статическим ключом требуется заранее сгенерировать общий ключ, который будет использоваться и сервером, и клиентом.  
На рабочей машине с linux установил пакет **openVPN**  
OpenVPN умеет создавать такой ключ встроенной командой: OpenVPN умеет создавать такой ключ встроенной командой: `openvpn --genkey secret secret.key`  
В результате создается файл secret.key со случайным набором байтов:  
![secret.key](./img/genkey-secret.png)  

### Использование ключа ###  
Сгенерированный ключ используется в файлах конфигурации как сервера так и клиента (что не является безопасным)  
В моем роутере не удалось работать с файлами, поэтому я буду использовать ключ в текстовом виде, и итоговый конфиг имеет вид:  
```
mode server
proto udp        
port 1194        
dev tun          
server 10.8.0.0 255.255.255.0  

# Ключ
<secret>
-----BEGIN OpenVPN Static key V1-----
6202a00746b2a117d7f6c1b4dfe5701b
d78b0d771393d9fc770feb16dbe39756
81da931ed5be978722895a3d9fb39540
3a3a25649f61c17b6a2481894eef46da
d1b66f1c488e81a378afbab5f3e7bf3a
0bdd3bc1200e50a16dfc66e48014baee
7c14bbd9cf81573751462bafcad3bdbd
9a555f24f5fbb1f0a92c93f2f28e0b37
033da12455834b36ad331c479a1d25eb
6e1f4c97b91d0a14bcc1177d626a1fb7
9398ff54a1d7c915b1deb9e51014fe93
bd20ae4e462de111360f8b3b297ad88c
9c92de4aa973670156459b82f75c91f9
b509ed517c0cdf37a8b04bbd5449d747
ed09b8f71a9c8802874cfd70a4ae9d85
10d33de784ce233567d1221391444434
-----END OpenVPN Static key V1-----
</secret>

cipher AES-256-CBC  
auth SHA256         
client-to-client
keepalive 10 120
verb 3
```
Этот конфиг необходимо вставить в поле при создании vpn-подключения на роутере. 


## Part 2. клиент OpenVPN ##  
Базовая конфигурация клиента:  
```
# Режим работы: клиент
client

# Тип интерфейса: TUN (роутинг) или TAP (ethernet)
dev tun

# Протокол и порт сервера
proto udp
remote <STATIC IP> 1194

# Статический ключ (сгенерированный ранее)
<secret>
-----BEGIN OpenVPN Static key V1-----
6202a00746b2a117d7f6c1b4dfe5701b
d78b0d771393d9fc770feb16dbe39756
81da931ed5be978722895a3d9fb39540
3a3a25649f61c17b6a2481894eef46da
d1b66f1c488e81a378afbab5f3e7bf3a
0bdd3bc1200e50a16dfc66e48014baee
7c14bbd9cf81573751462bafcad3bdbd
9a555f24f5fbb1f0a92c93f2f28e0b37
033da12455834b36ad331c479a1d25eb
6e1f4c97b91d0a14bcc1177d626a1fb7
9398ff54a1d7c915b1deb9e51014fe93
bd20ae4e462de111360f8b3b297ad88c
9c92de4aa973670156459b82f75c91f9
b509ed517c0cdf37a8b04bbd5449d747
ed09b8f71a9c8802874cfd70a4ae9d85
10d33de784ce233567d1221391444434
-----END OpenVPN Static key V1-----
</secret>

# Настройки шифрования
cipher AES-256-CBC  
auth SHA256   

# Сохранение состояния при переподключении
persist-tun
persist-key

# Механизм поддержания соединения
keepalive 10 60

# Поведение при переподключениях
resolv-retry infinite
nobind

# Перенаправление маршрутов (если нужно)
route 192.168.1.0 255.255.255.0
verb 3
```  
Важные моменты в клиентском конфиге (client.ovpn)  
`remote <ip> <port>` Необходимо указать статический (белый) адресс роутера. И порт указанный на севрере в конфигурации. 
Для настройки vpn необходим **статический адрес**, иначе клиент из вне несмодет "достучаться" до оборудования.  
`route 192.168.1.0 255.255.255.0` данная строка говорит о том что клиент получает доступ к сети 192.168.1.0/24 (т.е до локальной сети).  
`persist-tun` cохраняет состояние при обрыве или переподключении.  
`resolv-retry infinite` при возникновении ошибок бесконечное подключение.  
`nobind` клиент не пытается занять конкретный локальный порт.  
`persist-key` позволяет сохранять ключи в памяти.  

Клиентские утилиты присутствуют на различных платформах.  
В моем случае доступ необходим с пк под управлением linux
На Linux можно подключиться двумя способами:

- Через NetworkManager (графический интерфейс):
   1. Установить пакет `network-manager-openvpn`.
   2. В настройках сети выбрать «Добавить VPN».
   3. Указать тип «OpenVPN», импортировать файл `client.ovpn`.
   4. Включить подключение одним кликом.
   ![client](./img/client_added.png)  
- Через терминал:
   `sudo openvpn --config client.ovpn` а так же рекомендую добавить флаг **--daemon** указывающий OpenVPN работать как фоновый процесс.

## Part 3. Сертификаты и PKI ##  

Использование статического ключа (static key) подходит только для тестов, но не для боевого применения.  
В реальной эксплуатации OpenVPN чаще всего настраивается через **TLS с использованием PKI (Public Key Infrastructure)**.

### Что такое PKI и CA?
- **PKI (Инфраструктура открытых ключей)** — это система, которая управляет ключами и сертификатами.  
- В её основе — **Центр сертификации (CA, Certificate Authority)**.  
  Это как «главный ключ», который подписывает все остальные сертификаты.  
- CA создаёт:
  - Сертификат сервера (он доказывает клиенту, что он настоящий).
  - Сертификаты клиентов (каждый клиент получает свой уникальный сертификат).  

Главное преимущество:  
- Если у клиента украли ключ — можно **отозвать только его сертификат**, не ломая всю систему.  
- Все участники сети доверяют **CA**, а не друг другу напрямую.  

### Генерация сертификатов через OpenSSL
Для генерации ключей и сертификатов я использовал утилиту **openssl** (без готовых тулов вроде easy-rsa, чтобы руками понять процесс).

1. **Создать CA (корневой сертификат)**:  
Доверенный корень - CA является "корнем доверия" для всей системы  
- Подпись сертификатов - CA подписывает сертификаты сервера и клиентов  
- Верификация - **Клиенты проверяют**, что серверный сертификат подписан доверенным CA  
- Аутентификация - **Сервер проверяет**, что клиентские сертификаты подписаны тем же CA  
`ca.crt` — доверенный сертификат CA (общий для всех) создается командой:  
 `openssl req -x509 -new -nodes -key ca.key \`  
    `-sha256 -days 3650 -out ca.crt \`  
    `-subj "/C=RU/ST=Moscow/L=Moscow/O=HomeVPN/OU=CA/CN=HomeVPN-CA"`  
В команде уже все необходимые данные сертификата, алгоритм хэширования, срок действия и т.д  
Для удобства я создал скрипт `scripts/init-ca.sh` При запуске которого создается дериктория в которой будет секретный ключ и публичный сертификат.  

2. **Сертификат сервера**:  
Создается ключ **server.key**  
`openssl genrsa -out server.key 4096`  
Запрос на подпись (CSR) созданного ключа:  
`openssl req -new -key server.key -out server.csr`  
Подпись CSR корневым CA созданным первым шагом:  
`openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key \`  
  `-CAcreateserial -out server.crt -days 365 -sha256`
По итогу получаем подписанный сертификат.  
`scripts/gen-server.sh` - скрипт который автоматически создает ключ и сертификат в дериктории **server**. Скрипт так же запрашивает CN (Common Name) - это поле которое идентифицирует субъекта (владельца) сертификата. Необходимо всегда указывать осмысленные и уникальные значения!

3. **Сертификат клиента**:  
Создается по аналогии с предыдущим, создание ключа и подпись.  
Для этого использую скрипт `scripts/gen-client.sh` либо в ручную команды:  
`openssl genrsa -out client.key 4096`  
`openssl req -new -key client.key -out client.csr`  
`openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key \`  
  `-CAcreateserial -out client.crt -days 365 -sha256`  

### Повышение безопасности ###  
Приведенные ниже действия выполняются единоразово, как и CA (не для каждого клиента).  
1. Создание файл Диффи-Хелмана для защиты трафика от расшифровки. Он понадобится для использования сервером TLS.  
Параметры Диффи-Хеллмана позволяют создать сессионные ключи, создается командой `openssl dhparam -out dh.pem 2048` в моем случае я создавал файл размером 2048, т.к это занимает маньше времени, и достаточно для безопасности.  
2. ta.key это статический ключ, который добавляет дополнительный уровень защиты к TLS-соединению. Он пзволяет маркеровать пакеты подписывая этим ключем. Сервер и клиент **проверяют подпись** каждого пакета. Пакеты без правильной подписи **игнорируются**  
Защищает от:  
**DoS-атак** - злоумышленник не может flood-ить сервер  
**Port scanning** - порт не отвечает на неавторизованные пакеты  
**Replay attacks** - предотвращает повторную отправку перехваченных пакетов  
Создается ключ командой: `openvpn --genkey --secret ta.key`

Так же скрипты `scripts/gen-dh.sh` и `scripts/gen-ta-key.sh` позволяют создать необходимые файлы.

### Подводя итог ###
После этих дейтсвий должны получиться следующие файлы:  
- ca.crt – сертификат удостоверяющего центра
- dh.pem – файл Диффи-Хелмана
- server1.crt – сертификат сервера OpenVPN  
- server.key – закрытый ключ сервера OpenVPN  
- client.crt - сертификат 1-го клиента OpenVPN  
- client.key – закрытый ключ 1-го клиента OpenVPN   
- ta.key - ключ HMAC для дополнительной защиты от DoS-атак и флуда

Аналогично создаются файлы и для остальных клиентов при необходимости.  
Осталось только добавить их содержимое в текстовые файлы конфигурации сервера и клиентов.

## Part 4. Конфигурации сервер и клиенты ##  
После создания всех ключей и сертификатов можно перейти к написанию server.ovpn и client.ovpn.  
Используя тот же шаблок из первых частей.  
На сервере с openVPN можно использовать файлы (полеченный с помощью скриптов), но в моем случае с роутером keenetic, я использовал содержимое сгененированных файлов:  
С итоговым файлов конфигурации сервера можно ознакомиться `configs/server.ovpn` и клиентский `configs/client.ovpn`    
Для использования ключей нужно добавить блоки:  
1. Публичный сертификат твоего CA (корневого центра сертификации).
Нужен клиенту и серверу.  
Содержимое файла **ca.crt**:  
```
<ca>
-----BEGIN CERTIFICATE-----
          ca.crt
-----END CERTIFICATE-----
</ca>
```
2. Это публичный сертификат самого клиента или сервера. Подписанный CA.  
Содержимое файла **server.crt** или **client.crt**:  
```
<cert>
-----BEGIN CERTIFICATE-----
   server.crt / client.crt
-----END CERTIFICATE-----
</cert>
```
3. Приватный ключ.  
Содержимое файла **server.key** или **client.key**:  

```
<key>
-----BEGIN PRIVATE KEY-----
   server.key / client.key
-----END PRIVATE KEY-----
</key>
```
4. Параметры для обмена ключами.  
Содержимое файла **dh.pem**:  
```
<dh>
-----BEGIN DH PARAMETERS-----
          dh.pem
-----END DH PARAMETERS-----
</dh>
```
5. Статический ключ TLS.  
Содержимое файла **ta.key**: 
После ключа необходимо добавить строку `key-direction` со значением **0** для сервера, и **1** для клиента.  
key-direction указывает направление использования TLS-auth ключа.  
Ключ 0 → для пакетов сервер → клиент
Ключ 1 → для пакетов клиент → сервер
``` 
<tls-auth>
-----BEGIN OpenVPN Static key V1-----
          ta.key
-----END OpenVPN Static key V1-----
</tls-auth>
key-direction 0
```

Когда будет готов файл `server.ovpn` его содержимое необходимо так же вставить в веб-интерфес роутера: *другие подключения* - *vpn подключения* - *добавить подключение* - тип(протокол) **openVPN**  
![keenetic](./img/keenetic-satup-openvpn-2.png)  


